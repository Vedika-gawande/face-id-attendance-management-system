<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generate QR | Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5 text-center">
    <h3 class="mb-4">üì± Generate Attendance QR</h3>

    <div class="mb-3">
      <select id="subjectSelect" class="form-select w-50 mx-auto">
        <option value="">Select Subject or Lab</option>
        <option value="DBMS Lab">DBMS Lab</option>
        <option value="Web Development">Web Development</option>
        <option value="Python Programming">Python Programming</option>
        <option value="Computer Networks">Computer Networks</option>
      </select>
    </div>

    <button id="generateQR" class="btn btn-success">Generate QR</button>
    <div class="mt-4">
      <img id="qrDisplay" src="" width="250" style="display:none;">
      <p id="status" class="mt-3 text-success"></p>
    </div>
  </div>

<script>
  const token = localStorage.getItem("adminToken");
  if (!token) {
    alert("Please login first!");
    window.location.href = "qr_admin_login.html";
  }

  document.getElementById("generateQR").addEventListener("click", async () => {
    const subject = document.getElementById("subjectSelect").value;
    if (!subject) { alert("Select a subject or lab first!"); return; }

    const statusEl = document.getElementById("status");
    statusEl.textContent = "‚è≥ Generating QR‚Ä¶";

    try {
      const res = await fetch("http://192.168.33.136:8000/qr/generate", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ subject })
      });

      const data = await res.json();
      console.log("Response:", data);

      if (res.ok && data.qr_url) {
        let qrURL = data.qr_url;

        // Handle cases like relative path or localhost URL
        if (!qrURL.startsWith("http")) {
          qrURL = `http://192.168.33.136:8000${qrURL}`;
        }
        qrURL = qrURL
          .replace("127.0.0.1", "192.168.33.136")
          .replace("localhost", "192.168.33.136");

        console.log("Final QR URL:", qrURL);

        // Display the actual QR
        const qrImg = document.getElementById("qrDisplay");
        qrImg.src = qrURL;
        qrImg.style.display = "block";

        statusEl.textContent = `‚úÖ QR for "${subject}" generated successfully`;
      } else {
        statusEl.textContent = data.detail || "‚ö†Ô∏è Failed to generate QR.";
      }
    } catch (err) {
      console.error("Error generating QR:", err);
      statusEl.textContent = "‚ö†Ô∏è Network or server error.";
    }
  });
</script>

</body>
</html>
